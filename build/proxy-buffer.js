import y from"lodash";import h from"sharp";function i(o,e){for(let[a,t]of Object.entries(o.headers))try{e.setHeader(a,t)}catch{}}import c from"axios";var g=c.create({}),m=g;function l(o,e){e.headersSent||(e.setHeader("content-length",0),e.removeHeader("cache-control"),e.removeHeader("expires"),e.removeHeader("date"),e.removeHeader("etag"),e.setHeader("location",encodeURI(o.params.url)),e.status(302).end(),gc&&gc(),global.gc&&global.gc())}async function x(o,e){try{let a={...y.pick(o.headers,["cookie","dnt","referer"]),"Accept-Encoding":"*","user-agent":"Bandwidth-Hero Compressor","x-forwarded-for":o.headers["x-forwarded-for"]||o.ip,via:"1.1 bandwidth-hero"},t=await m({headers:a,url:o.params.url,responseType:"stream"});if(!t)throw new Error("no response (1)");let p=null,r=o.params.webp?"webp":"jpeg",s=parseInt(o.params.quality),n=p.format==="gif";if(n&&r==="jpeg")return t?.data.fill(0),t.data=null,r=null,s=null,n=null,l(o,e);t.data.pipe(h({animated:n,limitInputPixels:!1,failOn:"none",unlimited:!0}).grayscale(o.params.grayscale).toFormat(r,{quality:s,effort:6,progressive:!0,optimizeScans:!0,mozjpeg:!0}).toBuffer(function(u,f,d){if(u)throw u;if(!t)throw new Error("no response (2)");i(t,e),e.setHeader("content-encoding","identity"),e.setHeader("content-type",`image/${r}`),e.setHeader("content-length",d.size),e.status(200),e.write(f),e.end().on("close",function(){t?.data.fill(0),f.fill(0),t.data=null,r=null,s=null,n=null,gc&&gc(),global.gc&&global.gc()})}))}catch{return l(o,e)}}export{x as default};
