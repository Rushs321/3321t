import c from"lodash";import d from"sharp";import m from"axios";var l=m.create({}),a=l;function o(r,e){e.headersSent||(e.setHeader("content-length",0),e.removeHeader("cache-control"),e.removeHeader("expires"),e.removeHeader("date"),e.removeHeader("etag"),e.setHeader("location",encodeURI(r.params.url)),e.status(302).end(),gc&&gc(),global.gc&&global.gc())}async function f(r,e){try{let t={...c.pick(r.headers,["cookie","dnt","referer"]),"Accept-Encoding":"*","user-agent":"Bandwidth-Hero Compressor","x-forwarded-for":r.headers["x-forwarded-for"]||r.ip,via:"1.1 bandwidth-hero"},s=await a({headers:t,url:r.params.url,responseType:"stream"}),p=r.params.webp?"webp":"jpeg",n=parseInt(r.params.quality),i=d({limitInputPixels:!1,failOn:"none",unlimited:!0}).grayscale(r.params.grayscale).toFormat(p,{quality:n,effort:6,progressive:!0,optimizeScans:!0,mozjpeg:!0});s.data.pipe(i).pipe(e),gc&&gc(),global.gc&&global.gc()}catch{return o(r,e)}}export{f as default};
