import y from"express";function s(e,r,a){let t=e.query.url;if(Array.isArray(t)&&(t=t.join("&url=")),!t)return r.end("bandwidth-hero-proxy");t=t.replace(/http:\/\/1\.1\.\d\.\d\/bmi\/(https?:\/\/)?/i,"http://"),e.params.url=t,e.params.webp=e.query.jpg!="1",e.params.grayscale=e.query.bw!="0",e.params.quality=parseInt(e.query.l),a()}import d from"lodash";import g from"sharp";import u from"axios";var f=u.create({}),i=f;function p(e,r){r.headersSent||(r.setHeader("content-length",0),r.removeHeader("cache-control"),r.removeHeader("expires"),r.removeHeader("date"),r.removeHeader("etag"),r.setHeader("location",encodeURI(e.params.url)),r.status(302).end(),gc&&gc(),global.gc&&global.gc())}async function n(e,r){try{let a={...d.pick(e.headers,["cookie","dnt","referer"]),"Accept-Encoding":"*","user-agent":"Bandwidth-Hero Compressor","x-forwarded-for":e.headers["x-forwarded-for"]||e.ip,via:"1.1 bandwidth-hero"},t=await i({headers:a,url:e.params.url,responseType:"stream"}),l=e.params.webp?"webp":"jpeg",m=parseInt(e.params.quality),c=g({limitInputPixels:!1,failOn:"none",unlimited:!0}).grayscale(e.params.grayscale).toFormat(l,{quality:m,effort:6,progressive:!0,optimizeScans:!0,mozjpeg:!0});t.data.pipe(c).pipe(r),gc&&gc(),global.gc&&global.gc()}catch{return p(e,r)}}var o=y(),h=process.env.PORT||16406;o.enable("trust proxy");o.get("/",s,n);o.get("/favicon.ico",(e,r)=>r.status(204).end());o.listen(h,()=>{});setInterval(()=>{gc&&gc(),global.gc&&global.gc()},1e3);
